<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your Improvement Plan</title>

    <!-- Inline CSS for this page only -->
    <style>
        body {
            background: linear-gradient(135deg, #aad0ff, #f2f5ff);
            margin: 0;
            font-family: "Segoe UI", sans-serif;
        }

        .center-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 60px;
            padding-bottom: 60px;
        }

        .glass {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(12px);
            padding: 30px;
            border-radius: 16px;
            width: 750px;
            max-width: 90%;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        h2 {
            margin-top: 0;
        }

        .lead {
            color: #333;
            margin-bottom: 20px;
        }

        .btn-row {
            display: flex;
            gap: 14px;
            margin-bottom: 20px;
        }

        .btn {
            background: #0078ff;
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .btn:hover {
            background: #005fcc;
        }

        .btn.ghost {
            background: transparent;
            border: 1px solid #0078ff;
            color: #0078ff;
        }

        .btn.ghost:hover {
            background: #e1eeff;
        }

        /* Improvement Plan Box */
        #plan {
            background: rgba(255, 255, 255, 0.85);
            padding: 20px;
            border-radius: 16px;
            color: #222;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-height: 70vh;
            overflow-y: auto;
            font-size: 1rem;
            line-height: 1.5rem;
            margin-top: 10px;
        }

        /* Section Headers */
        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 8px;
            color: #000;
        }

        /* Cards */
        .weakness-card,
        .exercise-card,
        .resource-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Severity badges */
        .severity-badge {
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            margin-left: 10px;
            text-transform: capitalize;
        }

        .severity-high {
            background: #ff4d4d;
        }

        .severity-medium {
            background: #ffa600;
        }

        .severity-low {
            background: #00b14f;
        }

        /* Small text */
        .muted-small {
            color: #444;
            font-size: 0.9rem;
        }

        /* Resource Links */
        .resource-link {
            color: #0047ff;
            text-decoration: none;
        }

        .resource-link:hover {
            text-decoration: underline;
        }

        footer {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #666;
        }
    </style>
</head>

<body>
    <main class="center-card">
        <section class="glass">
            <h2>Improvement Plan</h2>

            <p class="lead">
                Your customized improvement plan based on your interview performance.
                This includes weaknesses, recommended exercises, and curated learning resources.
            </p>

            <div class="btn-row">
                <button id="generate-btn" class="btn">Generate Improvement Plan</button>
                <a class="btn ghost" href="interview.html">Back to Interview</a>
                <a class="btn ghost" href="upload.html">Upload New Docs</a>
            </div>

            <div id="plan">
                Click ‚ÄúGenerate Improvement Plan‚Äù to begin.
            </div>
        </section>

        <footer>Personalized learning roadmap will appear above.</footer>
    </main>

    <script>
        const generateBtn = document.getElementById("generate-btn");
        const planEl = document.getElementById("plan");
        const sessionId = localStorage.getItem("mi_session_id");

        function renderPlan(plan) {
            let html = "";

            html += `<div class="section-title">üìù Summary</div>`;
            html += `<p>${plan.summary}</p>`;

            if (plan.weaknesses?.length) {
                html += `<div class="section-title">‚ö†Ô∏è Weaknesses</div>`;
                plan.weaknesses.forEach(w => {
                    html += `
                        <div class="weakness-card">
                            <strong>${w.area.toUpperCase()}</strong>
                            <span class="severity-badge severity-${w.severity}">
                                ${w.severity}
                            </span>
                            <p class="muted-small">${w.explanation}</p>
                        </div>
                    `;
                });
            }

            if (plan.exercises?.length) {
                html += `<div class="section-title">üìò Recommended Exercises</div>`;
                plan.exercises.forEach(ex => {
                    html += `
                        <div class="exercise-card">
                            <strong>${ex.title}</strong>
                            <p class="muted-small">${ex.description}</p>
                            <p class="muted-small"><em>Estimated time: ${ex.time_estimate_min} minutes</em></p>
                        </div>
                    `;
                });
            }

            if (plan.resources?.length) {
                html += `<div class="section-title">üîó Resources</div>`;
                plan.resources.forEach(r => {
                    html += `
                        <div class="resource-card">
                            <strong>${r.title}</strong><br/>
                            <a class="resource-link" href="${r.url}" target="_blank">${r.url}</a>
                        </div>
                    `;
                });
            }

            return html;
        }

        generateBtn.addEventListener("click", async () => {
            if (!sessionId) {
                alert("Session missing ‚Äî upload documents again.");
                window.location.href = "upload.html";
                return;
            }

            planEl.innerHTML = "Generating improvement plan‚Ä¶";

            const form = new FormData();
            form.append("session_id", sessionId);

            try {
                const res = await fetch("/api/generate-improvement", {
                    method: "POST",
                    body: form,
                });

                const data = await res.json();

                if (!data.improvement_plan) {
                    planEl.innerHTML =
                        "‚ùå Error generating plan.<br><pre>" +
                        JSON.stringify(data, null, 2) +
                        "</pre>";
                    return;
                }

                planEl.innerHTML = renderPlan(data.improvement_plan);

            } catch (err) {
                planEl.innerHTML = "‚ùå Network error: " + err.message;
            }
        });
    </script>
</body>
</html>
